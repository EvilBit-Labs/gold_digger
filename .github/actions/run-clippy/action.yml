name: "Run Clippy Linting"
description: "Run cargo clippy with specified feature combinations"

inputs:
  features:
    description: "Feature combinations to test (comma-separated)"
    required: false
    default: "ssl,ssl-rustls,none"
  sarif-output:
    description: "Whether to generate SARIF output"
    required: false
    default: "false"
  sarif-prefix:
    description: "Prefix for SARIF output files"
    required: false
    default: "clippy"

runs:
  using: composite
  steps:
    - name: Run Clippy Linting
      shell: bash
      run: |
        set -euo pipefail

        # Check for SARIF tools if sarif-output is enabled
        if [[ "${{ inputs.sarif-output }}" == "true" ]]; then
          missing_tools=()

          if ! command -v clippy-sarif >/dev/null 2>&1; then
            missing_tools+=("clippy-sarif")
          fi

          if ! command -v sarif-fmt >/dev/null 2>&1; then
            missing_tools+=("sarif-fmt")
          fi

          if [[ ${#missing_tools[@]} -gt 0 ]]; then
            echo "‚ùå Error: Required SARIF tools are missing: ${missing_tools[*]}"
            echo "Please ensure clippy-sarif and sarif-fmt are installed and available in PATH"
            echo "Current PATH: $PATH"
            echo "Cargo bin location: $HOME/.cargo/bin"
            exit 1
          fi
        fi

        # Parse features input defensively - handle empty, comma-only, or comma-separated list
        FEATURES=()
        if [[ -n "${{ inputs.features }}" ]]; then
          # Trim the input string
          features_input=$(echo "${{ inputs.features }}" | xargs)
          if [[ -n "$features_input" ]]; then
            # Split by comma and build array with only non-empty trimmed entries
            IFS=',' read -ra raw_features <<< "$features_input"
            for raw_feature in "${raw_features[@]}"; do
              trimmed_feature=$(echo "$raw_feature" | xargs)
              if [[ -n "$trimmed_feature" ]]; then
                FEATURES+=("$trimmed_feature")
              fi
            done
          fi
        fi

        # Early guard: Check if FEATURES array is empty or contains only invalid entries
        if [[ ${#FEATURES[@]} -eq 0 ]]; then
          echo "‚ùå Error: No valid features specified for clippy linting"
          echo "Available features: ssl, ssl-rustls, none"
          echo "Received features input: '${{ inputs.features }}'"
          exit 1
        fi

        # Function to create empty SARIF file
        create_empty_sarif() {
          local feature=$1
          local filename="${{ inputs.sarif-prefix }}-${feature}.sarif"
          echo "Creating empty SARIF file: $filename"
          echo '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0-rtm.5.json","runs":[]}' > "$filename"
        }

        # Lint each feature combination
        processed=0
        for feature in "${FEATURES[@]}"; do
          # Skip empty entries explicitly
          if [[ -z "$feature" ]]; then
            continue
          fi
          case "$feature" in
            "ssl")
              echo "üîç Running clippy with ssl feature..."
              if [[ "${{ inputs.sarif-output }}" == "true" ]]; then
                # Run clippy and capture output to check for warnings
                clippy_output=$(cargo clippy --all-targets --no-default-features --features "json csv ssl additional_mysql_types verbose" --message-format=json -- -D warnings 2>&1)
                clippy_exit_code=$?

                if [[ $clippy_exit_code -eq 0 ]]; then
                  # Clippy succeeded, check if there are any warnings in the output
                  if echo "$clippy_output" | grep -q '"level":"warning"\|"level":"error"'; then
                    # There are warnings, process them through clippy-sarif
                    echo "$clippy_output" | clippy-sarif | tee "${{ inputs.sarif-prefix }}-ssl.sarif" | sarif-fmt
                    echo "‚úÖ Clippy SARIF generated for ssl feature (with warnings)"
                  else
                    # No warnings, create empty SARIF file
                    echo "‚úÖ Clippy succeeded with no warnings, creating empty SARIF"
                    create_empty_sarif "ssl"
                  fi
                else
                  # Clippy failed, create empty SARIF file
                  echo "‚ö†Ô∏è Clippy failed for ssl feature, creating empty SARIF"
                  create_empty_sarif "ssl"
                fi
              else
                # Stream output to both console and error log, preserve exit code
                cargo clippy --all-targets --no-default-features --features "json csv ssl additional_mysql_types verbose" -- -D warnings 2>&1 | tee /tmp/clippy_error.log
                clippy_exit_code=${PIPESTATUS[0]}
                if [[ $clippy_exit_code -ne 0 ]]; then
                  echo "‚ùå Clippy failed with ssl features (exit code: $clippy_exit_code):"
                  cat /tmp/clippy_error.log
                  exit $clippy_exit_code
                fi
              fi
              ((processed++))
              ;;
            "ssl-rustls")
              echo "üîç Running clippy with ssl-rustls feature..."
              if [[ "${{ inputs.sarif-output }}" == "true" ]]; then
                # Run clippy and capture output to check for warnings
                clippy_output=$(cargo clippy --all-targets --no-default-features --features "json csv ssl-rustls additional_mysql_types verbose" --message-format=json -- -D warnings 2>&1)
                clippy_exit_code=$?

                if [[ $clippy_exit_code -eq 0 ]]; then
                  # Clippy succeeded, check if there are any warnings in the output
                  if echo "$clippy_output" | grep -q '"level":"warning"\|"level":"error"'; then
                    # There are warnings, process them through clippy-sarif
                    echo "$clippy_output" | clippy-sarif | tee "${{ inputs.sarif-prefix }}-ssl-rustls.sarif" | sarif-fmt
                    echo "‚úÖ Clippy SARIF generated for ssl-rustls feature (with warnings)"
                  else
                    # No warnings, create empty SARIF file
                    echo "‚úÖ Clippy succeeded with no warnings, creating empty SARIF"
                    create_empty_sarif "ssl-rustls"
                  fi
                else
                  # Clippy failed, create empty SARIF file
                  echo "‚ö†Ô∏è Clippy failed for ssl-rustls feature, creating empty SARIF"
                  create_empty_sarif "ssl-rustls"
                fi
              else
                # Stream output to both console and error log, preserve exit code
                cargo clippy --all-targets --no-default-features --features "json csv ssl-rustls additional_mysql_types verbose" -- -D warnings 2>&1 | tee /tmp/clippy_error.log
                clippy_exit_code=${PIPESTATUS[0]}
                if [[ $clippy_exit_code -ne 0 ]]; then
                  echo "‚ùå Clippy failed with ssl-rustls features (exit code: $clippy_exit_code):"
                  cat /tmp/clippy_error.log
                  exit $clippy_exit_code
                fi
              fi
              ((processed++))
              ;;
            "none")
              echo "üîç Running clippy without TLS features..."
              if [[ "${{ inputs.sarif-output }}" == "true" ]]; then
                # Run clippy and capture output to check for warnings
                clippy_output=$(cargo clippy --all-targets --no-default-features --features "json csv additional_mysql_types verbose" --message-format=json -- -D warnings 2>&1)
                clippy_exit_code=$?

                if [[ $clippy_exit_code -eq 0 ]]; then
                  # Clippy succeeded, check if there are any warnings in the output
                  if echo "$clippy_output" | grep -q '"level":"warning"\|"level":"error"'; then
                    # There are warnings, process them through clippy-sarif
                    echo "$clippy_output" | clippy-sarif | tee "${{ inputs.sarif-prefix }}-notls.sarif" | sarif-fmt
                    echo "‚úÖ Clippy SARIF generated for no-TLS feature (with warnings)"
                  else
                    # No warnings, create empty SARIF file
                    echo "‚úÖ Clippy succeeded with no warnings, creating empty SARIF"
                    create_empty_sarif "notls"
                  fi
                else
                  # Clippy failed, create empty SARIF file
                  echo "‚ö†Ô∏è Clippy failed for no-TLS feature, creating empty SARIF"
                  create_empty_sarif "notls"
                fi
              else
                # Stream output to both console and error log, preserve exit code
                cargo clippy --all-targets --no-default-features --features "json csv additional_mysql_types verbose" -- -D warnings 2>&1 | tee /tmp/clippy_error.log
                clippy_exit_code=${PIPESTATUS[0]}
                if [[ $clippy_exit_code -ne 0 ]]; then
                  echo "‚ùå Clippy failed without TLS features (exit code: $clippy_exit_code):"
                  cat /tmp/clippy_error.log
                  exit $clippy_exit_code
                fi
              fi
              ((processed++))
              ;;
            *)
              echo "‚ö†Ô∏è Unknown feature: $feature, skipping..."
              ;;
          esac
        done

        # Check if any features were actually processed
        if [[ $processed -eq 0 ]]; then
          echo "‚ùå Error: No valid features were processed during clippy linting"
          echo "Available features: ssl, ssl-rustls, none"
          echo "Received features: ${FEATURES[*]}"
          exit 1
        fi

        # Print success message only if we reach this point (processed > 0)
        echo "‚úÖ Clippy linting completed successfully"
