---
inclusion: always
---

# Gold Digger Core Concepts

This document defines the essential architecture patterns, safety requirements, and development constraints for the Gold Digger MySQL/MariaDB query tool.

## Project Identity

- **Purpose**: Headless MySQL/MariaDB query tool for automation workflows
- **Design**: CLI-first with environment variable fallbacks, structured output (CSV/JSON/TSV)
- **Architecture**: Single-threaded, fully materialized results, offline-first
- **Status**: Active development toward v1.0 (currently v0.2.6)

## Critical Safety Requirements

### Security (NON-NEGOTIABLE)

- **NEVER** log `DATABASE_URL` or credentials - implement automatic redaction
- **NEVER** make external network calls at runtime (offline-first design)
- **ALWAYS** validate and sanitize all user inputs

## Configuration Architecture

### Resolution Priority: CLI → Environment → Error

```rust
// Standard pattern for all configuration values
fn resolve_config_value(cli: &Cli) -> anyhow::Result<String> {
    if let Some(value) = &cli.field {
        Ok(value.clone()) // CLI flag (highest priority)
    } else if let Ok(value) = env::var("ENV_VAR") {
        Ok(value) // Environment variable (fallback)
    } else {
        anyhow::bail!("Missing required configuration")
    }
}
```

### Required Configuration

| CLI Flag                   | Environment Variable | Purpose                                      |
| -------------------------- | -------------------- | -------------------------------------------- |
| `--db-url`                 | `DATABASE_URL`       | MySQL connection string                      |
| `--query` / `--query-file` | `DATABASE_QUERY`     | SQL to execute                               |
| `--output`                 | `OUTPUT_FILE`        | Output path (determines format by extension) |
| `--format`                 | -                    | Force output format (csv\|json\|tsv)         |

**Important**: No dotenv support - use exported environment variables only

## Module Architecture

```text
src/
├── main.rs     # CLI entry, config resolution, format dispatch
├── cli.rs      # Clap CLI definitions and validation
├── lib.rs      # Public API, shared utilities
├── csv.rs      # RFC4180 compliant with QuoteStyle::Necessary
├── json.rs     # {"data":[...]} with BTreeMap for deterministic ordering
└── tab.rs      # TSV fallback format
```

### Format Module Contract

All format modules must implement:

```rust
pub fn write<W: Write>(rows: Vec<Vec<String>>, output: W) -> anyhow::Result<()>
```

### Output Format Standards

- **CSV**: RFC4180 compliant, `QuoteStyle::Necessary` (quotes only when required)
- **JSON**: `{"data": [...]}` wrapper, BTreeMap ensures deterministic field ordering
- **TSV**: Tab-delimited fallback format

## Known Issues (High Priority Fixes)

1. **Memory**: No streaming support - O(row_count × row_width) memory usage

## Feature Flags

```toml
default = ["json", "csv", "additional_mysql_types", "verbose"]
json = [] # Enable JSON output format
csv = [] # Enable CSV output format  
additional_mysql_types = [ # Extended MySQL type support
  "mysql_common",
  "mysql_common?/bigdecimal",
  "mysql_common?/rust_decimal",
  "mysql_common?/time",
  "mysql_common?/frunk",
]
verbose = [] # Conditional println!/eprintln!
```

**Note**: TLS support is now always enabled and no longer a feature flag.

## Code Quality Standards (Zero Tolerance)

### Quality Gates (Required Before Commits)

```bash
just fmt-check    # cargo fmt --check (100-char line limit)
just lint         # cargo clippy -- -D warnings (zero tolerance)
just test         # cargo nextest run (preferred) or cargo test
just security     # cargo audit (advisory)
```

All recipes use `cd {{justfile_dir()}}` and support cross-platform execution.

### Commit Standards

- **Format:** Conventional commits (`feat:`, `fix:`, `docs:`, etc.)
- **Scope:** Use Gold Digger scopes: `(cli)`, `(db)`, `(output)`, `(tls)`, `(config)`
- **Automation:** cargo-dist handles versioning and distribution; git-cliff handles changelog generation
- **CI Parity:** All CI operations executable locally via `just` recipes
- **Important:** `.github/workflows/release.yml` is automatically generated by cargo-dist and should not be manually edited

### Code Quality Requirements

- **Formatting:** 100-character line limit via `rustfmt.toml`
- **Linting:** Zero clippy warnings (`-D warnings`)
- **Error Handling:** Use `anyhow` for applications, `thiserror` for libraries
- **Documentation:** Doc comments required for all public functions
- **Testing:** Target ≥80% coverage with `cargo tarpaulin`

## Essential Just Recipes

Key `justfile` targets for development workflow:

```bash
just setup        # Install development dependencies
just fmt          # Auto-format code
just fmt-check    # Verify formatting (CI-compatible)
just lint         # Run clippy with -D warnings
just test         # Run tests (cargo nextest preferred)
just ci-check     # Full CI validation locally
just build        # Build release artifacts
just docs         # Serve documentation locally
```

All recipes must use `cd {{justfile_dir()}}` and support cross-platform execution.

### Rust Style Guidelines

- Use `anyhow::Result<T>` for fallible functions
- Feature-gate verbose output: `#[cfg(feature = "verbose")]`
- Never log DATABASE_URL or credentials
- Handle NULL database values gracefully

## Security Invariants

1. **No credential logging** - implement redaction for DATABASE_URL
2. **Offline-first design** - no external service calls at runtime
3. **Respect system umask** for output file permissions
4. **TLS/SSL configuration** - must be configured programmatically via mysql crate's `SslOpts` and `OptsBuilder::ssl_opts()`; URL-based ssl-mode parameters are not supported by the mysql crate

## Memory & Performance Characteristics

- **Fully materialized results**: Loads all rows into memory (not streaming)
- **Connection pooling**: Uses mysql::Pool but no optimization
- **Memory scaling**: O(row_count × row_width)
- **Streaming requirement**: F007 in requirements.md calls for streaming support

## Requirements Gap (High Priority)

Current v0.2.6 → Target v1.0:

- **CLI present (clap-based)**: Clap-based interface exists; finalize config precedence and UX polish (F001–F003)
- **Exit code standards**: Proper error taxonomy implemented in src/exit.rs (F005 ✓)
- **Memory efficiency**: Implement streaming for large result sets (F007)
- **Streaming**: Memory-efficient large result processing (F007)

## Development Workflow

### Development Practices

- **Reviews**: CodeRabbit.ai preferred, disable GitHub Copilot auto-reviews
- **Scope**: Target small, reviewable changes for single-maintainer workflow

### Testing Strategy (Planned)

```toml
# Recommended test dependencies
criterion = "0.5"       # Benchmarking
insta = "1"             # Snapshot testing
assert_cmd = "2"        # CLI end-to-end
testcontainers = "0.15" # Database integration
```

## Safe Code Patterns

### Environment Variable Handling

```rust
let var_name = match env::var("VAR_NAME") {
    Ok(val) => val,
    Err(_) => {
        #[cfg(feature = "verbose")]
        eprintln!("couldn't find VAR_NAME in environment variable");
        std::process::exit(2);  // TODO: Use proper exit codes
    }
};
```

### Database Value Handling

```rust
// Safe NULL handling pattern
match database_value {
    mysql::Value::NULL => "".to_string(),
    val => from_value_opt::<String>(val)
        .unwrap_or_else(|_| format!("{:?}", val))
}
```

### Format Dispatch Pattern

```rust
match get_extension_from_filename(&output_file) {
    #[cfg(feature = "csv")]
    Some("csv") => gold_digger::csv::write(rows, output)?,
    #[cfg(feature = "json")]
    Some("json") => gold_digger::json::write(rows, output)?,
    Some(_) => gold_digger::tab::write(rows, output)?, // TSV fallback
    None => anyhow::bail!("missing file extension for output_file"),
}
```

## Essential Commands

```bash
# Build variations
cargo build --release                                    # Standard build (rustls TLS)
cargo build --release --no-default-features --features "json csv additional_mysql_types verbose"  # No TLS support
cargo build --no-default-features --features "csv json" # Minimal build

# Development (CLI-first approach)
cargo install --path .  # Local install
cargo run --release -- \
  --db-url "mysql://u:p@h:3306/db" \
  --query "SELECT id, name FROM users" \
  --output /tmp/out.json

# Quality assurance (pipeline standards)
just fmt-check    # cargo fmt --check (100-char line limit)
just lint         # cargo clippy -- -D warnings (zero tolerance)
just test         # cargo nextest run (preferred) or cargo test
just security     # cargo audit (advisory)
```
