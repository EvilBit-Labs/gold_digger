---
inclusion: always
---

# Gold Digger Development Pipeline Standards

## Development Workflow

### Quality Gates (Required Before Commits)

```bash
just fmt-check    # cargo fmt --check (100-char line limit)
just lint         # cargo clippy -- -D warnings (zero tolerance)
just test         # cargo nextest run (preferred) or cargo test
just security     # cargo audit (advisory)
```

### Commit Standards

- **Format:** Conventional commits (`feat:`, `fix:`, `docs:`, etc.)
- **Automation:** Release Please handles versioning and changelog
- **CI Parity:** All CI operations executable locally via `just` recipes

### Code Quality Requirements

- **Formatting:** 100-character line limit via `rustfmt.toml`
- **Linting:** Zero clippy warnings (`-D warnings`)
- **Error Handling:** Use `anyhow` for applications, `thiserror` for libraries
- **Documentation:** Doc comments required for all public functions
- **Testing:** Target ≥80% coverage with `cargo tarpaulin`

## Essential Just Recipes

Key `justfile` targets for development workflow:

```bash
just setup        # Install development dependencies
just fmt          # Auto-format code
just fmt-check    # Verify formatting (CI-compatible)
just lint         # Run clippy with -D warnings
just test         # Run tests (cargo nextest preferred)
just ci-check     # Full CI validation locally
just build        # Build release artifacts
just docs         # Serve documentation locally
```

All recipes must use `cd {{justfile_dir()}}` and support cross-platform execution.

## CI/CD Requirements

### GitHub Actions Workflows

- **ci.yml:** PR/push validation (formatting, linting, testing, security)
- **release-please.yml:** Automated release PRs with semantic versioning
- **release.yml:** Cross-platform artifact generation via `cargo-dist`

### CI Matrix Requirements

All code must pass on:

```yaml
os: [ubuntu-latest, windows-latest, macos-latest]
```

### Release Process

1. **Quality Gates:** All CI checks must pass
2. **Artifacts:** Cross-platform binaries with checksums and signatures
3. **Security:** SBOM generation, vulnerability scanning, Cosign signing
4. **Documentation:** Auto-generated changelog via conventional commits

## Security Requirements

### Mandatory Controls

- **No hardcoded secrets** in code or configuration
- **Credential redaction** in logs and error messages (especially `DATABASE_URL`)
- **Airgap compatibility** - only explicitly-configured service endpoints allowed:
  - **Allowed:** Configured database connections (MySQL/MariaDB), specified internal hosts
  - **Prohibited:** Telemetry, third-party call-home, non-essential outbound connections
  - **Documentation:** Required network endpoints and offline setup steps must be documented for airgapped environments
- **Vulnerability scanning** via `cargo audit` (advisory)
- **SBOM generation** - CycloneDX format JSON files for all releases

### Security Tools

- **CodeQL:** Static analysis for Rust code
- **Cosign:** Artifact signing with keyless OIDC
- **CodeRabbit.ai:** AI-powered code review (advisory)
- **CycloneDX:** SBOM generation using `cyclonedx-bom` cargo tool

## Documentation Standards

### Required Files

- `README.md` - Installation and usage instructions
- `CHANGELOG.md` - Auto-generated by Release Please
- Doc comments for all public functions and modules

### Documentation Tools

- **mdBook + RustDoc** comprehensive documentation site
- **Mermaid diagrams** for visual documentation
- Auto-deployment on push to `main` and release tags

## Dependency Management

### Renovate Configuration

- **Tool:** Renovate (preferred over Dependabot)
- **Schedule:** Weekly updates Monday mornings
- **Auto-merge:** Dev tools only (cargo-nextest, cargo-tarpaulin, just)
- **Production deps:** Manual review required

## Testing Standards

### Test Execution

- **Runner:** `cargo nextest run` (preferred) or `cargo test`
- **Coverage:** `cargo tarpaulin --out xml` targeting ≥80%
- **Cross-platform:** Must pass on macOS, Windows, Linux
- **No flaky tests:** Quarantine and fix regressions immediately

### Test Organization

- **Unit tests:** Core business logic and data processing
- **Integration tests:** Database interactions (consider testcontainers-rs)
- **CLI tests:** Command-line validation (assert_cmd crate)
- **Snapshot tests:** Output format validation (insta crate)

## Release Standards

### Release Criteria

All releases must satisfy:

1. **Quality gates:** All CI checks pass
2. **No critical vulnerabilities** (high vulnerabilities require justification)
3. **Cross-platform artifacts** via `cargo-dist`
4. **Checksums and signatures** for all artifacts
5. **SBOM generation** - CycloneDX JSON format with complete dependency information
6. **Documentation updates** for user-facing changes

### Artifact Requirements

- **Targets:** x86_64/aarch64 for Linux, macOS, Windows
- **Verification:** SHA256 checksums and Cosign signatures
- **Offline capability:** No external dependencies at runtime

## Cross-Platform Support

### Platform Requirements

- **macOS:** Latest stable and previous major version
- **Windows:** Windows 10/11 with standard tooling
- **Linux:** Ubuntu LTS and major distributions

### Platform Considerations

- Use cross-platform path operations
- Handle CRLF vs LF line endings consistently
- Account for Windows/Unix permission differences
- Ensure `just` recipes work without modification

## Gold Digger-Specific Standards

### Technology Stack

- **CLI Framework:** `clap` with environment variable fallbacks
- **Database:** MySQL/MariaDB via `mysql` crate with connection pooling
- **Output Formats:** CSV, JSON, TSV with file extension detection
- **Logging:** `tracing` crate with credential redaction
- **Error Handling:** `anyhow` for applications

### Operational Requirements

- **CLI-first design:** Headless operation via environment variables
- **Airgap compatibility:** No external network calls during operation
- **Security:** Never log `DATABASE_URL` or credentials
- **Type safety:** Handle MySQL NULL values and type conversions safely
- **Cross-platform:** Consistent behavior across all supported platforms

### Development Practices

- Use `just` commands for all development tasks
- Local development must match CI environment
- Environment variables validated before execution
- Database operations are read-only (no migrations)
